<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Terminal TDD</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
  <link rel="stylesheet" type="text/css" href="{{cssUri}}">
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
</head>
<body>
  <div id="timeline">
    <h2>TDDLab Timeline</h2>
    <div id="timeline-content">{{timelineContent}}</div>
  </div>

  <div class="terminal-wrapper">
    <div id="terminal"></div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    
        // funciÃ³n para pedir el prompt real al backend
    function requestPrompt() {
      vscode.postMessage({ command: 'requestPrompt' });
    }
    const term = new Terminal({ 
      cursorBlink: true,
      cols: 80,
      rows: 30,
      theme: {
        background: '#1e1e1e',
        foreground: '#ffffff'
      },
      allowTransparency: false,
      convertEol: true
    });
    
    const terminalElement = document.getElementById('terminal');
    term.open(terminalElement);
    
    setTimeout(() => {
      const xtermRows = terminalElement.querySelector('.xterm-rows');
      if (xtermRows) {
        xtermRows.style.textAlign = 'left';
        xtermRows.style.paddingLeft = '0';
        xtermRows.style.marginLeft = '0';
        xtermRows.style.width = '100%';
      }
      const xtermScreen = terminalElement.querySelector('.xterm-screen');
      if (xtermScreen) {
        xtermScreen.style.textAlign = 'left';
        xtermScreen.style.paddingLeft = '0';
        xtermScreen.style.marginLeft = '0';
      }
    }, 100);
    
    const fitAddon = () => {
      const container = document.querySelector('.terminal-wrapper');
      if (container) {
        const width = container.offsetWidth;
        const height = container.offsetHeight;
        const cols = Math.floor((width - 20) / 9); 
        const rows = Math.floor(height / 17); 
        term.resize(cols, rows);
      }
    };
    
    window.addEventListener('resize', fitAddon);
    setTimeout(fitAddon, 200);
    
    // PIDE EL PROMPT AL BACKEND
    requestPrompt();
    setTimeout(() => {
      term.scrollToBottom();
      term.focus();
    }, 0);
    
    let command = '';
    let isExecuting = false;

    term.onData(data => {
      const code = data.codePointAt(0);
      if (code === 13) { 
        if (command.trim() && !isExecuting) {
          isExecuting = true;
          vscode.postMessage({ command: 'executeCommand', text: command });
          command = '';
        } else if (!isExecuting) {
          requestPrompt();
          setTimeout(() => {
            term.scrollToBottom();
            term.focus();
          }, 0);  }
      } else if (code === 127) { 
        if (command.length > 0 && !isExecuting) {
          command = command.slice(0, -1);
          term.write('\b \b');
        }
      } else if (code === 3) { 
        term.write('^C');
        vscode.postMessage({ command: 'killCommand' });
        isExecuting = false;
      } else if (code >= 32 && code <= 126 && !isExecuting) {
        command += data;
        term.write(data);
      }
    });
    
    window.addEventListener('message', event => {
      const message = event.data;
      switch (message.command) {
        case 'updateTimeline':
          document.getElementById('timeline-content').innerHTML = message.html;
          break;
        case 'writeToTerminal':
          { 
          const text = message.text || '';
          term.write(text);
          setTimeout(() => {
            term.scrollToBottom();
            term.focus();
          }, 0);
          if (/\r?\n?.+> $/.test(text)) {
            isExecuting = false;
          }
          setTimeout(() => {
            term.scrollToBottom();
            term.focus();
          }, 0);
          break;
        }
        case 'clearTerminal':
          term.clear();
          requestPrompt();
          setTimeout(() => {
            term.scrollToBottom();
            term.focus();
          }, 0);
          isExecuting = false;
          command = '';
          break;
      }
    });
  </script>
</body>
</html>