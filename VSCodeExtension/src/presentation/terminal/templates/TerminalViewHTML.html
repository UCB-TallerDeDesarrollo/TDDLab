<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Terminal TDD</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
  <link rel="stylesheet" type="text/css" href="{{cssUri}}">
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
</head>
<body>
  <div id="timeline">
    <h2>TDDLab Timeline</h2>
    <div id="timeline-content">{{timelineContent}}</div>
  </div>

  <div class="terminal-wrapper">
    <div id="terminal"></div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    
    // Estado del terminal
    let terminalContent = '';
    let currentCommand = '';
    let isExecuting = false;

    const term = new Terminal({ 
      cursorBlink: true,
      cols: 80,
      rows: 30,
      theme: {
        background: '#1e1e1e',
        foreground: '#ffffff'
      },
      allowTransparency: false,
      convertEol: true
    });
    
    const terminalElement = document.getElementById('terminal');
    term.open(terminalElement);
    
    // Ajustar tamaño después de inicializar
    setTimeout(() => {
      const container = document.querySelector('.terminal-wrapper');
      if (container) {
        const width = container.offsetWidth;
        const height = container.offsetHeight;
        const cols = Math.floor((width - 20) / 9);
        const rows = Math.floor(height / 17);
        term.resize(cols, rows);
      }
    }, 100);
    
    window.addEventListener('resize', () => {
      const container = document.querySelector('.terminal-wrapper');
      if (container) {
        const width = container.offsetWidth;
        const height = container.offsetHeight;
        const cols = Math.floor((width - 20) / 9);
        const rows = Math.floor(height / 17);
        term.resize(cols, rows);
      }
    });
    
    // Notificar que el webview está listo
    vscode.postMessage({ command: 'webviewReady' });

    term.focus();
    
    term.onData(data => {
      const code = data.codePointAt(0);
      if (code === 13) { // Enter
        if (currentCommand.trim() && !isExecuting) {
          isExecuting = true;
          vscode.postMessage({ command: 'executeCommand', text: currentCommand });
          currentCommand = '';
        } else if (!isExecuting) {
          term.write('\r\n$ ');
          terminalContent += '\r\n$ ';
          vscode.postMessage({ command: 'contentUpdate', content: terminalContent });
        }
      } else if (code === 127) { // Backspace
        if (currentCommand.length > 0 && !isExecuting) {
          currentCommand = currentCommand.slice(0, -1);
          term.write('\b \b');
        }
      } else if (code === 3) { // Ctrl+C
        term.write('^C');
        vscode.postMessage({ command: 'killCommand' });
        isExecuting = false;
        term.write('\r\n$ ');
        terminalContent += '\r\n$ ';
        vscode.postMessage({ command: 'contentUpdate', content: terminalContent });
      } else if (code >= 32 && code <= 126 && !isExecuting) {
        currentCommand += data;
        term.write(data);
      }
    });
    
    window.addEventListener('message', event => {
      const message = event.data;
      switch (message.command) {
        case 'updateTimeline':
          document.getElementById('timeline-content').innerHTML = message.html;
          break;
          
        case 'writeToTerminal': {
          const text = message.text || '';
          term.write(text);
          terminalContent += text;
          vscode.postMessage({ command: 'contentUpdate', content: terminalContent });
          
          if (text.endsWith('\r\n$ ') || text.endsWith('$ ')) {
            isExecuting = false;
          }
          break;
        }
          
        case 'clearTerminal': {
          term.clear();
          term.write('$ ');
          currentCommand = '';
          isExecuting = false;
          terminalContent = '$ ';
          vscode.postMessage({ command: 'contentUpdate', content: terminalContent });
          break;
        }
          
        case 'restoreContent': {
          term.clear();
          const content = message.content || '$ ';
          term.write(content);
          terminalContent = content;
          currentCommand = '';
          isExecuting = false;
          break;
        }
      }
    });
  </script>
</body>
</html>